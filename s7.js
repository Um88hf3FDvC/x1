"use strict";const NO={n:"n"},OE=Object.entries,OK=Object.keys,RE=RegExp,RQ=require,CL=console.log,CE=console.error,JS=JSON.stringify,JP=JSON.parse,DN=Date.now,ZL=RQ("zlib"),CD=ZL.createDeflate,ID=ZL.createInflate,CZ=ZL.createGzip,IZ=ZL.createGunzip,CB=ZL.createBrotliCompress,IB=ZL.createBrotliDecompress,FS=RQ("fs"),CR=RQ("crypto"),SW=RQ("stream").Writable,SR=RQ("stream").Readable,PT=RQ("stream").PassThrough,MX=Math.max,MN=Math.min,NX=Number.MAX_VALUE,NN=Number.MIN_VALUE,X={PQ:(e,r)=>(OE(r).map(r=>{e[r[0]]=e[r[0]]||[],e[r[0]].push(r[1])}),e),J2P:e=>e.reduce(X.PQ,{}),P2J:e=>e[OK(e)[0]].map((r,t)=>OK(e).reduce((r,a,c)=>(r[a]=e[OK(e)[c]][t],r),{})),C2J:e=>e.split("\n").map((e,r,t)=>e.split(",").reduce((e,r,a)=>(e[t[0].split(",")[a]]=r,e),{})).slice(1),LOP:(e,r,t)=>(e[r]=t,e),LLP:e=>[...new Set(e)].reduce(X.LOP,{}),DOP:(e,r)=>(e[r]=(e[r]||0)+1,e),IT:e=>{switch(e){case"deflate":return ID();case"brotli":return IB();case"zip":return IZ();default:return new PT}},CT:e=>{switch(e){case"deflate":return CD();case"brotli":return CB();case"zip":return CZ();default:return new PT}}},http=RQ("http"),cfg=RQ("./package.json").config,rw={wbF:async(e,r,t,a=!0,c=e,s=CD(),u=r.zip)=>{const i=FS.createWriteStream(r.data||'./'+c+"."+u),l=new SR;l.push(JS(a?t[e]:t[e].filter(e=>e._utime>stime))),l.push(null),l.pipe(s).pipe(i),r.is_debug&&CL(`BKwbF${e}/${c} RECS ${t[e].length}`)},rbf:async(e,r,t,a=!1,c=ID(),s="deflate",u=e)=>{const i=FS.createReadStream(r.data||'./'+e+"."+s),l=new SW;let d=[],n=0;l.on("error",t=>r.is_debug&&CL("ERR WSTRM",e,t)),l.on("finish",()=>{let e=Buffer.alloc(n);for(let r=0,t=d.length,a=0;r<t;r++)d[r].copy(e,a),a+=d[r].length;t[u]=[].concat(a&&t[u]||[],JP(e.toString())),t._all[u]=t[u].length,"lookup"===s&&(t[u]=t[u][0]),r.is_debug&&CL(`WS4 ${u} LN ${n} RCS ${t[u].length}`)}),l.write=(e=>{d.push(e),n+=e.length}),i.pipe(c).pipe(l)},rbfa:async(e,r)=>{await Promise.all(e.tabs.map(async t=>rw.rbf(t,e,r)))},rdf:async(e,r)=>FS.readdir(e.app,(t,a)=>a.forEach(t=>FS.readFile(e.app+t,(a,c)=>{if(a)throw a;let s=e.is_fcrypt?CR.createHmac("sha256",e.cert+DN()).update(t).digest("hex"):t;r._file[t]=s,r[s]=c,e.is_debug&&CL(`fcrypt ${e.is_fcrypt} FILE ${t} loaded ${c.length} ${s}`)})))},FX={eF:e=>r=>t=>t[e].toString()===r.toString(),rF:e=>r=>t=>new RE(r,"i").test(t[e]),NrF:e=>r=>t=>!new RE(r,"i").test(t[e]),tF:e=>()=>r=>r[e],NtF:e=>()=>r=>!r[e],gF:e=>r=>t=>t[e]>=r,lF:e=>r=>t=>t[e]<=r,bF:e=>r=>t=>t[e]>=r.k&&t[e]<=r.g,NbF:e=>r=>t=>t[e]<=r.k&&t[e]>=r.g,iF:e=>r=>t=>new RE(r.join("|")).test(t[e]),mfs:e=>r=>t=>e.reduce((e,a)=>e||new RE(r.replace(/([*()\]])/g,"$1"),"i").test(t[a].replace(/[()<>;]/g,"").replace(/([.\/-])/g,"$1")),!1)},mfms=e=>(r,t)=>r.filter(FX.mfs(e)(t)),eof=e=>(r,t)=>(-1===r.indexOf(t[e])&&r.push(t[e]),r),fc=(e,r)=>e.filter(FX[r.f](r.k)(r.v)),fo=(e,r)=>(t,a)=>t.concat(e.filter(e=>e[r]===a)),as=e=>r=>e.reduce((e,t)=>(e[t]=r[t],e),{}),KV=e=>({k:e[0],v:e[1]}),DG=e=>e.reduce((e,r)=>(OE(r).reduce((e,r)=>(e[r[0]]=(e[r[0]]||0)+r[1],e),e),e),{}),MO=e=>e.reduce((e,r)=>(e[r]={},e),{}),aly=(e,r=1,t=1)=>(a,c)=>(OK(e).forEach(e=>{a[e][c[e]]=(a[e][c[e]]||0)+(c[r]||1)*(c[t]||1)}),a),U=(e,r)=>e.reduce((e,t)=>e+"_"+r[t],""),alx=(e,r,t=1,a=1)=>(r,c)=>(r[U(e,c)]=(r[U(e,c)]||0)+(c[t]||1)*(c[a]||1),r),ald=(e,r,t=1,a=1)=>(r,c)=>(r[U(e,c)]=(r[U(e,c)]||0)+(c[t]||0)-(c[a]||0),r),valm=(e,r,t=1,a=1)=>(r,a)=>(r[U(e,a)]=Math.max(r[U(e,a)]||Number.MIN_VALUE,a[t]||Number.MIN_VALUE),r),alm=(e,r,t=1,a=1)=>(r,a)=>(r[U(e,a)]=MX(r[U(e,a)]||NN,a[t]||NN),r),aln=(e,r,t=1,a=1)=>(r,a)=>(r[U(e,a)]=MN(r[U(e,a)]||NX,a[t]||NX),r),alb=(e,r,t=1,a=1)=>(r,a)=>(r[U(e,a)]=r[U(e,a)]||[],r[U(e,a)].push(a[t]||0),r),j2c=(e,r)=>e+OE(r).reduce((e,r)=>e+";"+r[1],"\nN"),icuv=(e,r)=>(e._id=e._id||"VSMC"+DN().toString(35)+r,e._ctime=e._ctime||DN(),e._utime=DN(),e._version=(e._version||0)+1,e),bxpl=e=>{const r=e.map(e=>e||0).sort((e,r)=>e-r),t=r.length,a=r.reduce((e,r)=>e+(r||0),0)/t;return{min:r[0],q1:r[parseInt(.25*t)],q5:r[parseInt(.5*t)],mean:a,q7:r[parseInt(.75*t)],max:r[t-1],l:t,v:r.reduce((e,r)=>e+(r-a)*(r-a),0)/t}},KB=e=>({k:e[0],v:bxpl(e[1])}),buzz=(e,r)=>OE(e.reduce((e,t)=>(t[r].split(/\W/).filter(e=>e.length>7).map(e=>e.toLowerCase()).reduce((e,r)=>(e[r]=(e[r]||0)+1,e),e),e),{})).map(KV).sort((e,r)=>r.v-e.v).slice(0,50),FC=(e,r="")=>new Promise((t,a)=>{"https"===e.prot&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");const c=require(e.prot).request({host:e.host,port:e.port,method:e.method,path:e.path,headers:{"Proxy-Authorization":e.pauth||"",Accept:"application/json",Authorization:"Basic "+e.auth,"x-encoding":e.senc?"deflate":"","accept-encoding":e.renc?"deflate":""}},r=>{let a=new SW,c=[],s=0;a.write=(e=>{c.push(e),s+=e.length}),a.on("error",e=>{CL("XRES-ErRor: "+e.message)}),a.on("finish",()=>{let e=Buffer.alloc(s);for(let r=0,t=c.length,a=0;r<t;r++)c[r].copy(e,a),a+=c[r].length;t(e.toString())}),e.renc?r.pipe(ZL.createInflate()).pipe(a):r.pipe(a)});c.on("error",e=>{CL("XREQ-ERror: "+e.message)});let s=new SR;s.push(r),s.push(null),e.senc?s.pipe(ZL.createDeflate()).pipe(c):s.pipe(c)}),FCSD=async(e,r)=>{await FC(e,r)},rest=(e,r,t,a,c,s,u)=>{const i=t[2],l=s&&JP(s);let d=null;switch(e.is_debug&&CL(`REST_${r}${t.length} ${i} ${a[i]&&a[i].length||"JSON"} ${s.slice(0,30)}`),r){case"GET":switch(t.length){case 3:"_cmd"===i?(e.is_debug&&CL("sfunc",l.sfunc,l.cmd),l.sfunc&&Function.apply(null,l.sfunc)(a,{w:SW,r:SR,h:RQ("http"),f:X}),l.cmd&&Function.apply(null,a.commands.filter(e=>e.cmd===l.cmd)[0].sfunc)(a,{w:SW,r:SR,h:RQ("http")})):c.push(JS(a[i]?a[i]:[NO]));break;case 4:switch(t[3]){case"_arfield":c.push(JS(a[i]?l.ar.reduce(fo(a[i],l.field),[]):[NO]));break;case"_ids":c.push(JS(a[i]?l.reduce(fo(a[i],"_id"),[]):[NO]));break;case"_unload":a[i]=[],a._all[i]=0;let s=process.memoryUsage();c.push(`{"unload":"${i}","heapTotal":${Math.round(s.heapTotal/1024/1024*1e3)/1e3},"heapUsed":${Math.round(s.heapUsed/1024/1024*1e3)/1e3}}`),e.is_debug&&CL(process.memoryUsage());break;case"_f":c.push(JS(a[i]?a[i][0]:[NO]));break;case"_l":c.push(JS(a[i]?a[i][a[i].length-1]:[NO]));break;case"_F":c.push(JS(a[i]?a[i].slice(0,5):[NO]));break;case"_L":c.push(JS(a[i]?a[i].slice(-5):[NO]));break;case"_v":c.push(JS(a[i]?a[i].sort((e,r)=>r._version-e._version).slice(0,5):[NO]));break;case"_u":c.push(JS(a[i]?a[i].sort((e,r)=>r._utime-e._utime).slice(0,5):[NO]));break;case"_p":a["prq_"+i]=X.J2P(a[i]),c.push("{}");break;case"_P":a["r_"+i]=X.P2J(a[i]),c.push("{}");break;case"_filter":c.push(JS(a[i]?l.reduce(fc,a[i]):[NO]));break;case"_structure":c.push(JS(a[i]?a[i].map(as(l)):[NO]));break;case"_combine":c.push(JS(a[i]?l.filter.reduce(fc,a[i]).map(as(l.structure)):[NO]));break;case"_ocombine":c.push(JS(a[i]?l.filter.reduce(fc,l.oar.reduce(fo(a[i],l.ofield),[])).map(as(l.structure)):[NO]));break;case"_mcombine":c.push(JS(a[i]?l.searchvalues.split(" ").reduce(mfms(l.searchfields),l.filter.reduce(fc,a[i])).map(as(l.structure)):[NO]));break;default:if("_cmd"===i){c.push(JS(Function.apply(null,Array.prototype.filter.call(a.commands,e=>e.cmd===t[3])[0].sfunc)(a,null)));break}if("_app"===i){const e=a[i].filter(e=>e._id===t[3]),r=Buffer.from(0<e.length?e[0].content:"20","hex").toString("utf8");c.push(r);break}if("_apb"===i){const e=a[i].filter(e=>e._id===t[3]),r=Buffer.from(0<e.length?e[0].content:"aGk=","base64").toString("ascii");c.push(r);break}if("_apc"===i){r=a[t[3]].reduce(j2c,"N;"+OE(a[t[3]][0]).map(e=>e[0]).join(";")),c.push(r);break}}break;case 5:c.push(JS(a[i]?a[i].filter(e=>e[t[3]]===t[4]):[NO]));break;default:c.push("{}")}break;case"POST":switch(t.length){case 3:switch(t[2]){case"_bulk":l.forEach(e=>{a[e.index]||(a[e.index]=[]),a[e.index].P(icuv(e.row,0))}),l.map(e=>e.index).forEach(e=>{a._utc[e]=DN(),a._all[e]=a[e].length});break;case"_miblk":l.map(e=>{a[e.index]||(a[e.index]=[]),a[e.index].push(icuv(e.row,0))}),l.map(e=>e.index).map(e=>{a._utc[e]=DN(),a._all[e]=a[e].length});break;case"_miablk":l.map(e=>{a[e.index]||(a[e.index]=[]),a[e.index]=[].concat(a[e.index],e.rows.map(e=>icuv(e,0)))}),l.map(e=>e.index).map(e=>{a._utc[e]=DN(),a._all[e]=a[e].length});break;default:!a[i]&&(a[i]=[]),a[i].push(icuv(l,0)),a._utc[i]=DN(),a._all[i]=a[i].length,c.push("{}")}break;case 4:switch(t[3]){case"_wget":FC(l).then(e=>a[i]=JP(e));break;case"_fetch":FCSD(l,JS(a[i]));break;case"_ffetch":FCSD(l.server,JS(l.filter.reduce(fc,a[i])));break;case"_fcfetch":FCSD(l.server,JS(l.filter.reduce(fc,a[i]).map(as(l.structure))));break;case"_ofetch":FCSD(l.server,JS(l.oar.reduce(fo(a[i],l.ofield),[])));break;case"_fcofetch":FCSD(l.server,JS(l.filter.reduce(fc,l.oar.reduce(fo(a[i],l.ofield),[])).map(as(l.structure))));break;case"_arfield":c.push(JS(a[i]?l.oar.reduce(fo(a[i],l.ofield),[]):[NO]));break;case"_primary":c.push(JS(OE(a[i].reduce(aly({_id:{}}),{_id:{}})._id).map(KV).filter(e=>e.v>1)));break;case"_summari":let r=l.reduce((e,r)=>(e[r]={},e),{});c.push(JS(OE(a[i].reduce(aly(r),r)[l[0]]).map(KV).filter(e=>e.v>1)));break;case"_sfunc":e.is_debug&&CL("SFUNC"),Function.apply(null,l)(a,{w:SW,r:SR,h:RQ("http"),f:X});break;case"_xsave":c.push(`{"save":"${i}","file":"${l.file}","index":"${l.index}","type":"${l.type}"}`),rw.wbF(l.index,e,a,!0,l.file,X.CT(l.type),l.type);break;case"_xload":rw.rbf(l.file,e,a,l.append,X.IT(l.type),l.type,l.index),c.push(`{"load":"${i}","file":"${l.file}","append":"${l.append}","index":"${l.index}","type":"${l.type}"}`);break;case"_ids":c.push(JS(a[i]?l.reduce(fo(a[i],"_id"),[]):[NO]));break;case"_summary":d=MO(l),c.push(JS(a[i].reduce(aly(d),d)));break;case"_fsummary":d=MO(l.structure),c.push(JS(l.filter.reduce(fc,a[i]).reduce(aly(d),d)));break;case"_fsummaryc":d=MO(l.structure),c.push(JS(l.filter.reduce(fc,a[i]).reduce(aly(d,l.cfield),d)));break;case"_fosummary":d=MO(l.structure),c.push(JS(l.filter.reduce(fc,l.oar.reduce(fo(a[i],l.ofield),[])).reduce(aly(d),d)));break;case"_fosummaryc":d=MO(l.structure),c.push(JS(l.filter.reduce(fc,l.oar.reduce(fo(a[i],l.ofield),[])).reduce(aly(d,l.cfield),d)));break;case"_fosummarycc":d=MO(l.structure),c.push(JS(l.filter.reduce(fc,l.oar.reduce(fo(a[i],l.ofield),[])).reduce(aly(d,l.cfield[0],l.cfield[1]),d)));break;case"_fcsummary":c.push(JS(OE(l.filter.reduce(fc,a[i]).reduce(alx(l.structure),{})).map(KV)));break;case"_fcsummaryc":c.push(JS(OE(l.filter.reduce(fc,a[i]).reduce(alx(l.structure,0,l.cfield),{})).map(KV)));break;case"_focsummaryc":c.push(JS(OE(l.filter.reduce(fc,l.oar.reduce(fo(a[i],l.ofield),[])).reduce(alx(l.structure,0,l.cfield),{})).map(KV)));break;case"_fcsummarycc":c.push(JS(OE(l.filter.reduce(fc,a[i]).reduce(alx(l.structure,0,l.cfield[0],l.cfield[1]),{})).map(KV)));break;case"_fcsummarydc":c.push(JS(OE(l.filter.reduce(fc,a[i]).reduce(ald(l.structure,0,l.cfield[0],l.cfield[1]),{})).map(KV)));break;case"_focsummarydc":c.push(JS(OE(l.filter.reduce(fc,l.oar.reduce(fo(a[i],l.ofield),[])).reduce(ald(l.structure,0,l.cfield[0],l.cfield[1]),{})).map(KV)));break;case"_fcsummarycx":c.push(JS(OE(l.filter.reduce(fc,a[i]).reduce(alm(l.structure,0,l.cfield),{})).map(KV)));break;case"_fcsummarycn":c.push(JS(OE(l.filter.reduce(fc,a[i]).reduce(aln(l.structure,0,l.cfield),{})).map(KV)));break;case"_fcsummarya":c.push(JS(OE(l.filter.reduce(fc,a[i]).reduce(alb(l.structure,0,l.cfield),{})).map(KV)));break;case"_fcsummaryb":c.push(JS(OE(l.filter.reduce(fc,a[i]).reduce(alb(l.structure,0,l.cfield),{})).map(KB)));break;case"_entries":c.push(JS(DG(a[i])));break;case"_fentries":c.push(JS(DG(l.filter.reduce(fc,a[i]))));break;case"_flentries":c.push(JS(DG(l.filter.reduce(fc,a[i]).map(e=>(delete e.L,e)))));break;case"_boxplot":d=l.reduce((e,r)=>(e[r]=bxpl(a[i].map(e=>e[r])),e),{}),c.push(JS(d));break;case"_fboxplot":d=l.structure.reduce((e,r)=>(e[r]=bxpl(l.filter.reduce(fc,a[i]).map(e=>e[r])),e),{}),c.push(JS(d));break;case"_foboxplot":d=l.structure.reduce((e,r)=>(e[r]=bxpl(l.filter.reduce(fc,l.oar.reduce(fo(a[i],l.ofield),[])).map(e=>e[r])),e),{}),c.push(JS(d));break;case"_buzz":c.push(JS(a[i]?buzz(a[i],l.cfield):[NO]));break;case"_fbuzz":c.push(JS(a[i]?buzz(l.filter.reduce(fc,a[i]),l.cfield):[NO]));break;case"_fobuzz":c.push(JS(a[i]?buzz(l.filter.reduce(fc,l.oar.reduce(fo(a[i],l.ofield),[])),l.cfield):[NO]));break;case"_filter":c.push(JS(a[i]?l.reduce(fc,a[i]):[NO]));break;case"_combine":c.push(JS(a[i]?l.filter.reduce(fc,a[i]).map(as(l.structure)):[NO]));break;case"_structure":c.push(JS(a[i]?a[i].map(as(l)):[NO]));break;case"_ocombine":c.push(JS(a[i]?l.filter.reduce(fc,l.oar.reduce(fo(a[i],l.ofield),[])).map(as(l.structure)):[NO]));break;case"_mcombine":c.push(JS(a[i]?l.searchvalues.split(" ").reduce(mfms(l.searchfields),l.filter.reduce(fc,a[i])).map(as(l.structure)):[NO]));break;case"_bulk":a[i]||(a[i]=[]),l.forEach(icuv),a[i]=a[i].concat(l),a._utc[i]=DN(),a._all[i]=a[i].length}break;case 5:switch(e.is_debug&&CL(5,"POST",t[3],t[4]),t[4]){case"raspc":e.is_debug&&CL(5,"POST","raspc"),RQ("./swSendUDP")(l);break;case"mail":e.is_debug&&CL(5,"POST","mail",l),RQ("./swMailClient")(l)}break;case 6:let r=a[i].filter(e=>e._id===t[3]);1===r.length&&(r[0][t[4]]=t[5],r[0]=icuv(r[0],0));break;default:c.push("{}")}break;case"PUT":switch(t.length){case 3:if("_bulk"===i)e.is_debug&&CL("MIDX BULK UPD"),OK(l).forEach(r=>{e.is_debug&&CL("_BULK Multiindex ",r),OK(l[r]).map(e=>{let t=a[r].filter(r=>r._id===e);1===t.length&&(OE(l[r][e]).forEach(e=>{"object"==typeof e[1]?(t[0][e[0]].time.push(e[1][0]),t[0][e[0]].value.push(e[1][1]),t[0][e[0]].last=e[1][1],t[0][e[0]].time.length>t[0][e[0]].max&&(t[0][e[0]].time.shift(),t[0][e[0]].value.shift())):t[0][e[0]]=e[1]}),t[0]=icuv(t[0],0))}),a._utc[r]=DN()});else if(a._utc[i]=DN(),a[i]){let r=a[i].filter(e=>e._id===l._id);1===r.length?(e.is_debug&&CL("DS ID EXistiert "),OK(l).forEach(e=>{r[0][e]=l[e]}),r[0]=icuv(r[0],0)):(e.is_debug&&CL("!ID OR MORE"),a[i].push(icuv(l,0)))}else a[i]=[],a[i].push(icuv(l,0));break;case 6:let r=a[i].filter(e=>e._id===t[3]);1===r.length&&(r[0][t[4]]=t[5],r[0]=icuv(r[0],0)),a._utc[i]=DN();break;case 4:a[i]||(a[i]=[{_id:t[3]}]);let c=a[i].filter(e=>e._id===t[3]);1===c.length&&(OK(l).forEach(e=>{c[0][e]=l[e]}),c[0]=icuv(c[0],0)),a._utc[i]=DN(),e.is_debug&&CL("_PUT_4",(u[i]||[]).length),(u[i]||[]).forEach(e=>e.write(`event:put\ndata:{"index":"${i}","_id":"${t[3]}","msg":${JS(l)}}\n\n`));break;case 5:a[i]||(a[i]=[{_id:t[3]}]),e.is_debug&&CL(`ES PUT ${i} _ID${t[3]} TP:${t[4]} TN:${(u[i]||[]).length}`);let s=a[i].filter(e=>e._id===t[3]);if(1===s.length){switch(t[4]){case"acandidate":case"ocandidate":s[0][t[4]]||(s[0][t[4]]=[]),s[0][t[4]].push(l[t[4]]);break;default:OK(l).forEach(e=>{s[0][e]=l[e]})}s[0]=icuv(s[0],0)}u[i].forEach((e,r,a)=>e.write(`event:update\ndata:{"type":"${t[4]}","index":"${i}","users":${a.length},"msg":"msg${t[4]}","time":${Date.now()}}\n\n`)),a._utc[i]=DN()}break;case"DELETE":switch(t.length){case 3:delete a[i];break;case 4:switch(t[3]){case"_filter":a[i]=l.reduce(fc,a[i]);break;case"_structure":l.forEach(e=>{a[i].forEach(r=>r[e]&&delete r[e])});break;default:a[i]=a[i].filter(e=>e._id!==t[3])}}a._utc[i]=DN(),a._all[i]=(a[i]||[]).length}},port=process.env.PORT||cfg.webport,ipaddress=process.env.IP||"0.0.0.0",router=(e,r,t,a,c)=>{e.on('error',x=>{CE('REQ',x);r.end()});r.on('error',x=>CE('RES',x));let s="",u=[],i=0;const l=e.method,d=e.url,n=e.headers["accept-encoding"]||"ac.n.v.",p=e.headers["x-encoding"]||"xe.n.v.",f=/\/rest\//.test(d),o=/\/rest\/_ap[c]\//.test(d),h=/\/rest\/_ap[pb]\//.test(d),_=/\/event-source\//.test(d),b=!(f||_),m=d.split("?")[0].split("/"),g=m[f||_?2:1],S=n&&n.match(/\bdeflate\b/),k=p&&p.match(/\bdeflate\b/);a.is_debug&&CL(`ROUTER X ${p}[${k}] AC ${n}[${S}] URL ${e.url} METHOD ${e.method} bevent${_}`);let O=new SW,N=[],E=0;O.on("finish",()=>{let e=Buffer.alloc(E);for(let r=0,t=N.length,a=0;r<t;r++)N[r].copy(e,a),a+=N[r].length;if(s=e.toString(),a.is_debug&&CL(`WS-${e.toString("hex").slice(0,200)} - LEN ${E} POSTDATA.length:${s.length} `),_)r.writeHead(200,{Connection:"keep-alive","Content-Type":"text/event-stream","Cache-Control":"no-cache"}),c[g]=c[g]||[],c[g].push(r),a.is_debug&&CL(`ES (bevent:${_}) EVIndex:${g} ${c[g].length}`),r.write(`retry:60000\nid:${Date.now().toString(35)}\ndata:{"type":"new","index":"${g}","time":${Date.now()}}\n\n`),c[g].forEach((e,r,t)=>e.write(`data:{"type":"new user","index":"${g}","users":${t.length},"time":${Date.now()}}\n\n`));else{r.setHeader("Access-Control-Allow-Origin","*"),r.writeHead(200,{"content-encoding":"deflate","content-type":!f||h||o?h?"text/html;charset=utf-8":o?"text/csv;charset=utf-8":"":"application/json"});let e=new SR;S?e.pipe(ZL.createDeflate()).pipe(r):e.pipe(r),b&&e.push(t[g]?t[g]:t[a.first]),f&&rest(a,l,m,t,u,s,c),e.push(u[0]),i=u[0]?u[0].length:0,e.push(null)}}),O.write=(e=>{N.push(e),E+=e.length}),p&&p.match(/\bdeflate\b/)?(a.is_debug&&CL("wir haben ein deflate"),e.pipe(ZL.createInflate()).pipe(O)):e.pipe(O),e.on("end",()=>{a.is_debug&&CL(`RQEND ${h?"FREST ":""}${b?"FILE ":""}${f?"REST ":""}${_?"EVENT":""} [${l}] ${d}(${m.length}) IDX:${g} DT.l:${s.length} zip:${S}`)}),r.on("close",()=>{a.is_debug&&CL(`RES.CLS bEV:${_} IDX:${g}  dp${c[g]||"NEP"} ByteIn:${s.length}`),a.is_log&&t._log.push({byte_out:i,byte_in:s.length||0,_utime:DN(),method:e.method,path:e.url,remote:e.connection.remoteAddress.split(":").pop()}),t._utc._log=DN(),c[g]&&(c[g]=c[g].filter(e=>e!==r))}),r.on("aborted",()=>CL("RES.ABRTD"))};let data={_utc:{},_log:[],_file:{},_app:[],_all:{},default:" ",login:cfg.login},stime=DN(),sub={},bsub=!1;cfg.is_data&&rw.rbfa(cfg,data),cfg.is_app&&rw.rdf(cfg,data),cfg.is_incremental&&setInterval(()=>{OK(data._utc).filter(e=>data._utc[e]>stime).forEach(async e=>await rw.wbF(e,cfg,data,!1,e+"_"+stime.toString(),new PT,"txt")),stime=DN()},cfg.backup_time),http.createServer((e,r)=>router(e,r,data,cfg,sub)).listen(port,ipaddress,()=>{cfg.is_debug&&CL(`listen${port} ${ipaddress}`)});
